{
    "name": "Find all Synchronization accounts possibly used for Entra ID Connect",
    "category": "Hybrid - Entra ID Connect",
    "queryList": [
        {
            "final": true,
            "query": "MATCH (u) WHERE (u:User OR u:AZUser) AND (u.name =~ '(?i)^MSOL_|.*AADConnect.*' OR u.userprincipalname =~ '(?i)^sync_.*') OPTIONAL MATCH (u)-[:HasSession]->(s:Session) RETURN u, s",
            "allowCollapse": true
        }
    ]
}
{
    "name": "Find all Sessions of Synchronization accounts possibly used for Entra ID Connect",
    "category": "Hybrid - Entra ID Connect",
    "queryList": [
        {
            "final": true,
            "query": "MATCH p = (m:Computer)-[:HasSession]->(n) WHERE (n:User OR n:AZUser) AND ((n.name =~ '(?i)^MSOL_|.*AADConnect.*') OR (n.userPrincipalName =~ '(?i)^sync_.*')) RETURN p",
            "allowCollapse": true
        }
    ]
}
{
    "name": "Find all Entra ID Connect Servers",
    "category": "Hybrid - Entra ID Connect",
    "queryList": [
        {
            "final": true,
            "query": "MATCH (n:AZUser) WHERE n.name =~ '(?i)^SYNC_(.*?)_(.*?)@.*' WITH n, split(n.name, '_')[1] AS computerNamePattern MATCH (c:Computer) WHERE c.name CONTAINS computerNamePattern RETURN c",
            "allowCollapse": true
        }
    ]
}
{
    "name": "Find shortest Paths to Entra ID Connect Servers from Owned Users",
    "category": "Hybrid - Entra ID Connect",
    "queryList": [
        {
            "final": true,
            "query": "MATCH (n:AZUser) WHERE n.name =~ '(?i)^SYNC_(.*?)_(.*?)@.*' WITH n, split(n.name, '_')[1] AS computerNamePattern MATCH (c:Computer) WHERE c.name CONTAINS computerNamePattern WITH collect(c) AS computers MATCH p = shortestPath((u:User)-[*]-(c:Computer)) WHERE c IN computers AND length(p) > 0 AND u.owned = true RETURN u, p",
            "allowCollapse": true
        }
    ]
}